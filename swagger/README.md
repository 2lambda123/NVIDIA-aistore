## Python Client Package

## Table of Contents
- [Overview](#overview)
- [How to generate package](#how-to-generate-package)
- [How to run tests](#how-to-run-tests)
- [How to install](#how-to-install)
- [How to use package](#how-to-use-package)
    - [Overview](#overview-1)
    - [Creating Api Clients](#creating-api-clients)
    - [Performing Operations](#performing-operations)
        - [Bucket](#bucket)
        - [Cluster](#cluster)
        - [Daemon](#daemon)
        - [Object](#object)
        - [Sort](#sort)
        - [Querying](#querying)
- [Future](#future)

## Overview

OpenAPI Generator (formerly called Swagger) is used to generate a python client package for simplied integration with the RESTful API.

Note that, as of AIS v2.0, [python3 is currently not fully supported](#future).

A description of the package and how to use it can be found [here](#how-to-use).

The file [rest-api-specification.yaml](rest-api-specification.yaml) specifies the API endpoints that the package provides and should remain up to date with any changes to them in AIS.

The documentation for OpenAPI Generator itself can be found [here](https://github.com/openapitools/openapi-generator).

## How to generate package

The python client package is generated by [openapitools/openapi-generator](https://github.com/openapitools/openapi-generator), and will be placed in `<path_to_repo>/python-client`.

As of AIS v2.0, the repository does not store the generated package, and therefore you must follow the following steps to generate the package before running any [tests](#how-to-run-tests) or [installing](#how-to-install-client-package) it.

Should you have any difficulty with these instructions, please open a ticket, and we will provide assistance. 

1. Obtain the latest as of writing openapi-generator jar by running the following command:
    
    ```shell
    wget http://central.maven.org/maven2/org/openapitools/openapi-generator-cli/3.3.4/openapi-generator-cli-3.3.4.jar -O openapi-generator-cli.jar
    ```

2. Run the following commands:

    ```shell
    cd <path_to_repo>
    java -jar </path/to/openapi-generator-cli.jar> generate -i swagger/rest-api-specification.yaml -g python -o ./python-client/
    ```

3. Install `pip` - a package management system used to install and manage software packages written in Python. Visit the [installation page](https://pip.pypa.io/en/stable/installing/) for instructions on how to install `pip`.

4. Install required Python packages using `pip` and requirement files located in `python-client` directory:

    ```shell
    pip install -r python-client/requirements.txt
    pip install -r python-client/test-requirements.txt
    ```

If you don't wish to install these packages system wide for a particular user, consider using a [virtual environment](https://pypi.org/project/virtualenv/).

Afterwards, if for any reason you want to remove the generated package, you can do the following:

```shell
# remember to commit any manually edited files first
cd <path_to_repo>
git clean -fd -- python-client
git checkout HEAD -- python-client
find python-client -name "*.pyc" -delete
```

## How to run tests

First, ensure that you have followed [the instructions for generating the package](#how-to-generate-package).

Next, ensure that your machine has a [local testing deployment of AIS](../README.md#local-non-containerized).

Note that you do not need to install the package to run tests.

Run tests by running the following command:

```shell
cd <path_to_repo>
BUCKET=<bucket_name> python -m unittest discover python-client/
```

## How to install

First, ensure that you have followed [the instructions for generating the package](#how-to-generate-package).

Then install the package by doing:
```shell
cd <path_to_repo>/python-client
pip uninstall openapi_client #uninstalls any previous versions
pip install .
```

## How to use package

### Overview

This package works by creating python objects (called 'api client' in this document) representing a target or proxy.

It is designed to provide a python interface of the same functionality as the [RESTful API](../docs/http_api.md)

Operations on the client instance can be preformed by using it to create another python object (called 'api instance' in this document).

### Creating Api Clients

First, ensure that you have followed [the instructions for installing the package](#how-to-install)

1. In your python script or interpreter, import the python package 
    ```shell
    import openapi_client

    #Some aliases for functions in the package, will use later in document as shorthand
    openapi_models = openapi_client.models
    openapi_params = openapi_models.InputParameters
    openapi_actions = openapi_models.Actions
    ```

2. For each proxy or target url that you want to communcate with, create an api client
    ```shell
    #Initalize the configuration object
    configuration = openapi_client.Configuration()
    configuration.debug = False
    
    #Example first api client
    proxy_url = 'localhost:8080' #Change this to your your proxy's ip, ex: 172.50.0.2:8080
    configuration.host = 'http://%s/v1/' % proxy_url
    proxyClient = openapi_client.ApiClient(configuration)

    #Example second api client
    target_url = 'localhost:8089' #Change this to your your target's ip, ex: 172.50.0.2:8083
    configuration.host = 'http://%s/v1/' % target_url
    targetClient = openapi_client.ApiClient(configuration)
    ```

### Performing Operations

Create api instances for each api client that you want to perform operations on.

Each different api instance can perform a particular group of operations.

This means that, for each api client, you will have to create multiple api instances if you want to run operations from multiple groups.

The following sections list instructions for creating api instance and how to use it to perform operations, partitioned by group.

The return type for each operation is also listed. Some of them are objects specific to the package. Documentation for said objects are generated along with the package, and can be viewed to obtain a list of their properties. 

| Object Name | Document Location |
| --- | --- |
| ObjectPropertyList | `</path/to/package>/docs/ObjectPropertyList.md` |
| BucketNames | `</path/to/package>/docs/BucketNames.md` |

Note that operations may raise `openapi_client.rest.ApiException` as part of normal operations. The `status` property of the ApiException can hold some useful information.

#### Bucket

First, create an api instance `bucketAPI = openapi_client.api.bucket_api.BucketApi(proxyClient)`.

| Operation | Code Example | Return Type |
| --- | --- | --- | 
| Get bucket names | `bucketAPI.list_names()` <sup>[1](#ftb1)</sup>  | BucketNames |
| List objects in bucket | `bucketAPI.perform_operation('myS3bucket', openapi_params(openapi_actions.LISTOBJECTS, value=openapi_models.ObjectPropertiesRequestParams(props="size")))` <sup>[2](#ftb2)</sup> | ObjectPropertyList|
| Create local bucket (proxy) | `bucketAPI.perform_operation('mybucket', openapi_params(openapi_actions.CREATELB))` | ObjectPropertyList |
| Destroy local bucket (proxy) | `bucketAPI.delete('mybucket', openapi_params(openapi_actions.DESTROYLB))` | None |
| Rename local bucket (proxy) | `bucketAPI.perform_operation('oldname', openapi_params(openapi_actions.RENAMELB, name='newname'))` | ObjectPropertyList |
| Set bucket props (proxy) | `bucketAPI.set_properties('mybucket', openapi_params(openapi_actions.SETPROPS, value=openapi_models.BucketProps(next_tier_url="http://localhost:8082", cloud_provider="ais", read_policy="next_tier", write_policy="next_tier", cksum_config=openapi_models.BucketPropsCksum(checksum="inherit"))))` | None |
| Prefetch a list of objects | `bucketAPI.perform_operation('mybucket', openapi_params(openapi_actions.PREFETCH, value=openapi_models.ListParameters(objnames=["o1","o2","o3"], deadline="10s", wait=True)))` <sup>[3](#ftb3)</sup> | ObjectPropertyList |
| Prefetch a range of objects | `bucketAPI.perform_operation('mybucket', openapi_params(openapi_actions.PREFETCH, value=openapi_models.RangeParameters(prefix="__tst/test-", regex='\\d22\\d', range="1000:2000", deadline="10s", wait=True)))` <sup>[3](#ftb3)</sup> | None |
| Delete a list of objects | `bucketAPI.delete('mybucket', openapi_params(openapi_actions.DELETE, value=openapi_models.ListParameters(objnames=["o1","o2","o3"], deadline="10s", wait=True)))` <sup>[3](#ftb3)</sup> | None |
| Delete a range of objects | `bucketAPI.delete('mybucket', openapi_params(openapi_actions.DELETE, value=openapi_models.RangeParameters(prefix="__tst/test-", regex='\\d22\\d', range="1000:2000", deadline="10s", wait=True)))` <sup>[3](#ftb3)</sup> | None |
| Evict a list of objects | `bucketAPI.delete('mybucket', openapi_params(openapi_actions.EVICT, value=openapi_models.ListParameters(objnames=["o1","o2","o3"], deadline="10s", wait=True)))` <sup>[3](#ftb3)</sup> | None |
| Evict a range of objects | `bucketAPI.delete('mybucket', openapi_params(openapi_actions.EVICT, value=openapi_models.RangeParameters(prefix="__tst/test-", regex='\\d22\\d', range="1000:2000", deadline="10s", wait=True)))` <sup>[3](#ftb3)</sup> | None |
| Get bucket props (proxy) | `bucketAPI.get_properties_with_http_info('mybucket')[2]` | dict |

<a name="ftb1">1</a>: Optional parameter `loc=true` can be used to retrieve just the local buckets, this causes the `cloud` property to be the empty array

<a name="ftb2">2</a>: See the [List Bucket section](../docs/list_bucket.md#list-bucket) for details. 

<a name="ftb3">3</a>: See the [List/Range Operations section](../docs/batch.md#listrange-operations) for details.

#### Cluster

First, create an api instance `clusterAPI = openapi_client.api.cluster_api.ClusterApi(proxyClient)`.

| Operation | Code Example | Return Type |
| --- | --- | --- | 
| Unregister storage target | clusterAPI.unregister_target("15205:8083") | None |
| Register storage target | `mNetInfo = openapi_models.NetInfo(node_ip_addr="172.16.175.41", daemon_port="8083", direct_url="http://172.16.175.41:8083")`<br>`clusterAPI.register_target(openapi_models.Snode(daemon_id="43888:8083", public_net=mNetInfo, intra_control_net=mNetInfo, intra_data_net=mNetInfo))` | None |
| Set primary proxy forcefully(primary proxy) | `clusterAPI.set_primary_proxy("43888:8083")` | dict |
| Set cluster-wide configuration (proxy) | `clusterAPI.perform_operation(openapi_params(openapi_actions.SETCONFIG, name="stats_time", value="1s"))` <br> please see [runtime configuration](docs/configuration.md#runtime-configuration) for the option list | None |
| Shutdown cluster (proxy)| `clusterAPI.perform_operation(openapi_params(openapi_actions.SHUTDOWN))` | None |
| Rebalance cluster (proxy)| `clusterAPI.perform_operation(openapi_params(openapi_actions.REBALANCE))` | None |

#### Daemon

First, create an api instance `daemonAPI = openapi_client.api.daemon_api.DaemonApi(targetClient)`.

| Operation | Code Example | Return Type |
| --- | --- | --- | 
| Update individual AIStore daemon (proxy or target) configuration | `daemonAPI.perform_operation(openapi_params(openapi_actions.SETCONFIG, name="stats_time", value="1s"))` <br> please see [runtime configuration](docs/configuration.md#runtime-configuration) for the option list | None |
| Shutdown cluster (proxy)| `daemonAPI.perform_operation(openapi_params(openapi_actions.SHUTDOWN))` | None |
| Disable mountpath in target | `daemonAPI.modify_mountpath(openapi_params(openapi_actions.DISABLE, value="/mount/path"))` | None <sup>[1](#ftd1)</sup>  |
| Enable mountpath in target | `daemonAPI.modify_mountpath(openapi_params(openapi_actions.ENABLE, value="/mount/path"))` | None <sup>[1](#ftd1)</sup> |
| Remove mountpath from target | `daemonAPI.remove_mountpath(openapi_params(openapi_actions.REMOVE, value="/mount/path"))` | None |
| Add mountpath in target | `daemonAPI.create_mountpath(openapi_params(openapi_actions.ADD, value="/mount/path"))` | None |

<a name="ftd1">1</a>: raises ApiException with `status` of `204` if the mountpath is already enabled/disabled or `404` if mountpath was not found.

#### Object

First, create an api instance `objectAPI = openapi_client.api.object_api.ObjectApi(proxyClient)`.

| Operation | Code Example | Return Type |
| --- | --- | --- | 
| Get object (proxy) | `objectAPI.get('myS3bucket', 'myobject')` | str | 
| Read range (proxy) | `objectAPI.get('myS3bucket', 'myobject', offset=1024, length=512)` | str | 
| Put object (proxy) | `objectAPI.put('myS3bucket', 'myobject', body='object content here')` | None | 
| Rename/move object (local buckets) | `objectAPI.perform_operation('mylocalbucket', 'dir1/CCCCCCC', input_parameters=openapi_params(openapi_actions.RENAME, 'dir2/DDDDDDD'))` | None | 
| Delete object | `objectAPI.delete('mybucket', 'myobject')` | None | 
| Evict object from cache | `objectAPI.delete('mybucket', 'myobject', input_parameters=openapi_params(openapi_actions.EVICT))` | None | 
| Get object props | `objectAPI.get_properties_with_http_info('mybucket', 'myobject')[2]` | dict | 
| Check if an object is cached | `objectAPI.get_properties_with_http_info('mybucket', 'myobject', check_cached=True)` | tuple (raises ApiException if answer is no) |

Note that the `Copy object` operation (`objectAPI.put` with the kwargs `from_id`/`to_id` instead of `body`) doesn't work yet.

#### Sort

First, create an api instance `sort_api = openapi_client.api.sort_api.SortApi(proxyClient)`.

See the files mentioned [here](../dsort/playground/README.md#python) for examples of how to use `sort_api`.

#### Querying

AIStore provides an extensive list of operations to retrieve cluster current state.

Note that these are called on the api instances [clusterAPI](#cluster) and [daemonAPI](#daemon)

| Operation | Code Example | Return Type |
| --- | --- | --- | 
| Get cluster map | `daemonAPI.get(openapi_models.GetWhat.SMAP)` | dict | 
| Get proxy or target configuration | `daemonAPI.get(openapi_models.GetWhat.CONFIG)` | dict | 
| Get proxy/target info	 | `daemonAPI.get(openapi_models.GetWhat.DAEMONINFO`) | dict | 
| Get cluster statistics (proxy) | `clusterAPI.get(openapi_models.GetWhat.STATS)` | dict | 
| Get target statistics | `daemonAPI.get(openapi_models.GetWhat.STATS)` | dict | 
| Get rebalance statistics (proxy) | `clusterAPI.get(openapi_models.GetWhat.XACTION, props=openapi_models.GetProps.REBALANCE)` | dict | 
| Get prefetch statistics (proxy) | `clusterAPI.get(openapi_models.GetWhat.XACTION, props=openapi_models.GetProps.PREFETCH)` | dict |
| Get list of target's filesystems (target) | `daemonAPI.get(openapi_models.GetWhat.MOUNTPATHS)` | dict | 
| Get list of all targets' filesystems (proxy) | `clusterAPI.get(openapi_models.GetWhat.MOUNTPATHS)` | dict | 
| Get target bucket list | `daemonAPI.get(openapi_models.GetWhat.BUCKETMD)` | dict | 

## Future

The python package, as of AIS v2.0, is only fully supported in python 2.

This is because openapi-generator has a problem in python3 with fetching binary data in the form of octet-stream.
```
https://github.com/OpenAPITools/openapi-generator/issues/1445
https://github.com/OpenAPITools/openapi-generator/issues/206
```
For now, as of AIS v2.0, it's recommended to only use python 2 with the package